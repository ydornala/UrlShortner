{"version":3,"sources":["auth/auth.service.js"],"names":["validateJwt","secret","config","secrets","session","isAuthenticated","use","req","res","next","query","hasOwnProperty","headers","authorization","access_token","cookies","token","User","findById","user","_id","exec","then","status","end","catch","err","signToken","id","role","jwt","sign","expiresIn","setTokenCookie","send","cookie","redirect"],"mappings":";;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA,IAAMA,WAAW,GAAG,yBAAW;AAC3BC,EAAAA,MAAM,EAAEC,qBAAOC,OAAP,CAAeC;AADI,CAAX,CAApB;;AAIO,SAASC,eAAT,GAA2B;AAC9B,SAAO,qCACFC,GADE,CACE,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAC1B,QAAGF,GAAG,CAACG,KAAJ,IAAaH,GAAG,CAACG,KAAJ,CAAUC,cAAV,CAAyB,cAAzB,CAAhB,EAA0D;AACtDJ,MAAAA,GAAG,CAACK,OAAJ,CAAYC,aAAZ,oBAAsCN,GAAG,CAACG,KAAJ,CAAUI,YAAhD;AACH;;AAED,QAAGP,GAAG,CAACG,KAAJ,IAAa,OAAOH,GAAG,CAACK,OAAJ,CAAYC,aAAnB,KAAqC,WAArD,EAAkE;AAC9DN,MAAAA,GAAG,CAACK,OAAJ,CAAYC,aAAZ,oBAAsCN,GAAG,CAACQ,OAAJ,CAAYC,KAAlD;AACH;;AAEDhB,IAAAA,WAAW,CAACO,GAAD,EAAMC,GAAN,EAAWC,IAAX,CAAX;AACH,GAXE,EAYFH,GAZE,CAYE,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAC1BQ,kBAAKC,QAAL,CAAcX,GAAG,CAACY,IAAJ,CAASC,GAAvB,EAA4BC,IAA5B,GACKC,IADL,CACUH,IAAI,IAAI;AACV,UAAG,CAACA,IAAJ,EAAU;AACN,eAAOX,GAAG,CAACe,MAAJ,CAAW,GAAX,EAAgBC,GAAhB,EAAP;AACH;;AACDjB,MAAAA,GAAG,CAACY,IAAJ,GAAWA,IAAX;AACAV,MAAAA,IAAI;AACJ,aAAO,IAAP;AACH,KARL,EASKgB,KATL,CASWC,GAAG,IAAIjB,IAAI,CAACiB,GAAD,CATtB;AAUH,GAvBE,CAAP;AAwBH;;AAEM,SAASC,SAAT,CAAmBC,EAAnB,EAAuBC,IAAvB,EAA6B;AAChC,SAAOC,sBAAIC,IAAJ,CAAS;AAACX,IAAAA,GAAG,EAAEQ;AAAN,GAAT,EAAoB1B,qBAAOC,OAAP,CAAeC,OAAnC,EAA4C;AAC/C4B,IAAAA,SAAS,EAAE,KAAK,EAAL,GAAU;AAD0B,GAA5C,CAAP;AAGH;;AAEM,SAASC,cAAT,CAAwB1B,GAAxB,EAA6BC,GAA7B,EAAkC;AACrC,MAAG,CAACD,GAAG,CAACY,IAAR,EAAc;AACV,WAAOX,GAAG,CAACe,MAAJ,CAAW,GAAX,EAAgBW,IAAhB,CAAqB,wDAArB,CAAP;AACH;;AACD,MAAIlB,KAAK,GAAGW,SAAS,CAACpB,GAAG,CAACY,IAAJ,CAASC,GAAV,EAAeb,GAAG,CAACY,IAAJ,CAASU,IAAxB,CAArB;AACArB,EAAAA,GAAG,CAAC2B,MAAJ,CAAW,OAAX,EAAoBnB,KAApB;AACAR,EAAAA,GAAG,CAAC4B,QAAJ,CAAa,2BAAyBpB,KAAtC;AACH","sourcesContent":["import config from '../config/environment';\nimport jwt from 'jsonwebtoken';\nimport expressJwt from 'express-jwt';\nimport compose from 'composable-middleware';\nimport User from '../api/User/User.model';\n\nconst validateJwt = expressJwt({\n    secret: config.secrets.session\n});\n\nexport function isAuthenticated() {\n    return compose()\n        .use(function(req, res, next) {\n            if(req.query && req.query.hasOwnProperty('access_token')) {\n                req.headers.authorization = `Bearer ${req.query.access_token}`;\n            }\n\n            if(req.query && typeof req.headers.authorization === 'undefined') {\n                req.headers.authorization = `Bearer ${req.cookies.token}`;\n            }\n\n            validateJwt(req, res, next);\n        })\n        .use(function(req, res, next) {\n            User.findById(req.user._id).exec()\n                .then(user => {\n                    if(!user) {\n                        return res.status(401).end();\n                    }\n                    req.user = user;\n                    next();\n                    return null;\n                })\n                .catch(err => next(err));\n        });\n}\n\nexport function signToken(id, role) {\n    return jwt.sign({_id: id}, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n    });\n}\n\nexport function setTokenCookie(req, res) {\n    if(!req.user) {\n        return res.status(404).send('It looks like you aren\\'t logged in, please try again.');\n    }\n    var token = signToken(req.user._id, req.user.role);\n    res.cookie('token', token);\n    res.redirect('/success?access_token='+token);\n}"],"file":"auth.service.js"}